<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Unidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* Estilo para inputs de la tabla */
        .table-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-align: center;
        }
        .table-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Indicador de Carga -->
    <div id="loading-indicator" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50">
        <div class="p-4 bg-white rounded-lg shadow-lg flex items-center space-x-3">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Cargando datos y conectando a Firebase...</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg">

        <!-- Cabecera -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
            <h1 id="floor-title" class="text-3xl font-bold text-gray-800 text-center mb-4 md:mb-0"></h1>
            <div class="flex items-center space-x-4">
                <select id="floor-selector" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option>SUBSUELO</option>
                    <option>PLANTA BAJA</option>
                    <option>PISO 1</option>
                    <option>PISO 2</option>
                    <option>PISO 3</option>
                </select>
                <button id="end-day-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md whitespace-nowrap">
                    Finalizar Día
                </button>
            </div>
        </header>

        <!-- Tabla de Insumos -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="text-left py-3 px-4 uppercase font-semibold text-sm w-2/5">Insumo</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Inventario</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Separado</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Sobrante</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Gastado</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Acciones</th>
                    </tr>
                </thead>
                <tbody id="insumos-table-body" class="text-gray-700">
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Agregar Nuevo Insumo -->
        <div class="mt-8 pt-6 border-t">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Agregar Nuevo Insumo</h2>
            <form id="add-insumo-form" class="flex flex-col md:flex-row items-end gap-4">
                <div class="flex-grow w-full">
                    <label for="new-insumo-name" class="block text-sm font-medium text-gray-700">Nombre del Insumo</label>
                    <input type="text" id="new-insumo-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="w-full md:w-auto">
                    <label for="new-insumo-inventory" class="block text-sm font-medium text-gray-700">Inventario Inicial</label>
                    <input type="number" id="new-insumo-inventory" min="0" value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                    Agregar
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Insumo -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Insumo</h2>
            <form id="edit-insumo-form">
                <input type="hidden" id="edit-original-name">
                <div class="mb-4">
                    <label for="edit-insumo-name" class="block text-sm font-medium text-gray-700">Nombre del Insumo</label>
                    <input type="text" id="edit-insumo-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-6">
                    <label for="edit-insumo-inventory" class="block text-sm font-medium text-gray-700">Inventario</label>
                    <input type="number" id="edit-insumo-inventory" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 modal-content text-center">
            <h2 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-button" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md">Cancelar</button>
                <button id="confirm-ok-button" class="bg-red-600 text-white px-6 py-2 rounded-md">Aceptar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales y Setup de Firebase (MANDATORIO) ---
        // Se utilizan variables inyectadas por el entorno para la configuración
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let unsubscribeFloor = () => {}; // Función para limpiar el listener anterior
        
        // Estado de la aplicación
        let floorsData = {};
        let currentFloor = localStorage.getItem('currentFloor') || 'SUBSUELO';
        let isAuthReady = false;

        // Elementos del DOM
        const loadingIndicator = document.getElementById('loading-indicator');
        const floorSelector = document.getElementById('floor-selector');
        const floorTitle = document.getElementById('floor-title');
        const tableBody = document.getElementById('insumos-table-body');
        const addInsumoForm = document.getElementById('add-insumo-form');
        const endDayButton = document.getElementById('end-day-button');
        const editModal = document.getElementById('edit-modal');
        const editInsumoForm = document.getElementById('edit-insumo-form');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const confirmModal = document.getElementById('confirm-modal');

        const defaultInsumos = [
            { name: 'AGUJA CORTA', inventory: 48, separated: 0, surplus: 0 },
            { name: 'AGUJA LARGA', inventory: 119, separated: 0, surplus: 0 },
            { name: 'AGUJA PEDIATRICA', inventory: 8, separated: 0, surplus: 0 },
            { name: 'ANESTESICO LIDO', inventory: 22, separated: 0, surplus: 0 },
            { name: 'ANESTESICO MEPI', inventory: 44, separated: 0, surplus: 0 },
            { name: 'CAMPO DE OJO NO ESTERIL', inventory: 113, separated: 0, surplus: 0 },
            { name: 'CEPILLOS', inventory: 36, separated: 0, surplus: 0 },
            { name: 'CERA ENCAJONADO', inventory: 70, separated: 0, surplus: 0 },
            { name: 'COPAS', inventory: 176, separated: 0, surplus: 0 },
            { name: 'CUBETAS AZULES', inventory: 17, separated: 0, surplus: 0 },
            { name: 'EYECTOR DE SALIVA', inventory: 36, separated: 0, surplus: 0 },
            { name: 'GODIVA', inventory: 35, separated: 0, surplus: 0 },
            { name: 'JERINGA', inventory: 8, separated: 0, surplus: 0 },
            { name: 'SUTURA 3/0', inventory: 0, separated: 0, surplus: 0 },
            { name: 'SUTURA 4/0', inventory: 6, separated: 0, surplus: 0 },
            { name: 'PUNTAS AMARILLAS', inventory: 30, separated: 0, surplus: 0 },
            { name: 'CUBETA VERDE', inventory: 167, separated: 0, surplus: 0 },
            { name: 'CUBETAS AMARILLAS', inventory: 38, separated: 0, surplus: 0 },
            { name: 'CERA BASE', inventory: 20, separated: 0, surplus: 0 }
        ];

        // --- Funciones de Utilidad de Firebase ---
        function getFloorDocRef(floorName) {
            // Ruta pública para datos compartidos: /artifacts/{appId}/public/data/inventory_control/{floorName}
            return doc(db, `artifacts/${appId}/public/data/inventory_control/${floorName}`);
        }

        async function saveFloorDataToFirestore() {
            if (!db || !isAuthReady) {
                console.error("Firestore no está inicializado o el usuario no está autenticado.");
                return;
            }
            if (!floorsData[currentFloor]) {
                console.warn(`No hay datos para guardar para el piso: ${currentFloor}`);
                return;
            }

            const dataToSave = {
                insumos: floorsData[currentFloor],
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(getFloorDocRef(currentFloor), dataToSave, { merge: true });
                // console.log(`Datos guardados exitosamente para el piso: ${currentFloor}`);
            } catch (error) {
                console.error("Error al guardar datos en Firestore:", error);
                // Mostrar un mensaje de error al usuario si es crítico
            }
        }

        function startFirestoreListener() {
            // Detener el listener anterior
            unsubscribeFloor();
            
            if (!db || !isAuthReady) return;

            const docRef = getFloorDocRef(currentFloor);
            
            // Iniciar nuevo listener
            unsubscribeFloor = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    floorsData[currentFloor] = data.insumos || [];
                    renderTable();
                } else {
                    // Si no existe, inicializar con los datos por defecto y guardarlos
                    console.log(`Documento para ${currentFloor} no encontrado. Inicializando con valores por defecto.`);
                    floorsData[currentFloor] = JSON.parse(JSON.stringify(defaultInsumos));
                    saveFloorDataToFirestore(); // Crea el documento
                }
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error al escuchar en Firestore:", error);
                loadingIndicator.classList.add('hidden');
            });
        }

        function switchFloor(newFloor) {
            localStorage.setItem('currentFloor', newFloor);
            currentFloor = newFloor;
            floorTitle.textContent = `Control de Unidades - ${currentFloor.replace('_', ' ')}`;
            
            if (isAuthReady) {
                loadingIndicator.classList.remove('hidden');
                startFirestoreListener();
            } else {
                // Renderizar vacío hasta que Firebase esté listo
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Conectando...</td></tr>`;
            }
        }

        // --- Funciones de Inicialización ---
        async function setupFirebaseAndAuth() {
            try {
                // setLogLevel('debug'); // Descomentar para debug de Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;
                // Una vez autenticado, iniciar la carga de datos del piso actual
                switchFloor(currentFloor); 

            } catch (error) {
                console.error("Error al configurar Firebase/Auth:", error);
                loadingIndicator.innerHTML = '<span class="text-red-600">Error de conexión con la base de datos.</span>';
            }
        }

        // --- Funciones de Confirmación (sin cambios) ---
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');

            const okButton = document.getElementById('confirm-ok-button');
            const cancelButton = document.getElementById('confirm-cancel-button');

            const okHandler = () => {
                onConfirm();
                hideConfirmModal();
                cleanup();
            };
            const cancelHandler = () => {
                hideConfirmModal();
                cleanup();
            };
            
            function cleanup() {
                okButton.removeEventListener('click', okHandler);
                cancelButton.removeEventListener('click', cancelHandler);
            }

            okButton.addEventListener('click', okHandler);
            cancelButton.addEventListener('click', cancelHandler);
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        // --- Funciones de Renderizado ---
        function renderTable() {
            tableBody.innerHTML = '';
            const insumos = floorsData[currentFloor] || [];
            
            insumos.sort((a, b) => a.name.localeCompare(b.name));

            if (insumos.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay insumos para este piso. Agrega uno nuevo para empezar.</td></tr>`;
                return;
            }

            insumos.forEach(insumo => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                const gastado = Math.max(0, insumo.separated - insumo.surplus);

                row.innerHTML = `
                    <td class="text-left py-3 px-4 font-medium">${insumo.name}</td>
                    <td class="text-center py-3 px-4">${insumo.inventory}</td>
                    <td class="text-center py-3 px-4"><input type="number" min="0" value="${insumo.separated}" class="table-input separated-input" data-name="${insumo.name}"></td>
                    <td class="text-center py-3 px-4"><input type="number" min="0" value="${insumo.surplus}" class="table-input surplus-input" data-name="${insumo.name}"></td>
                    <td class="text-center py-3 px-4 font-semibold gastado-cell">${gastado}</td>
                    <td class="text-center py-3 px-4">
                        <button class="edit-button p-1 text-blue-600 hover:text-blue-800" data-name="${insumo.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a2 2 0 012-2h2.586l-4.586 4.586V12zM3 13.172V17h3.828l7.586-7.586-3.828-3.828L3 13.172z" /></svg>
                        </button>
                        <button class="delete-button p-1 text-red-600 hover:text-red-800" data-name="${insumo.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- Manejadores de Eventos ---
        floorSelector.addEventListener('change', (e) => {
            switchFloor(e.target.value);
        });

        tableBody.addEventListener('input', (e) => {
            const target = e.target;
            if (!target.classList.contains('table-input')) return;

            const name = target.dataset.name;
            // Asegurarse de que el valor es un número entero no negativo
            const value = Math.max(0, parseInt(target.value, 10) || 0);
            target.value = value; // Sincronizar el input con el valor validado
            
            const insumo = floorsData[currentFloor].find(i => i.name === name);

            if (insumo) {
                if (target.classList.contains('separated-input')) {
                    insumo.separated = value;
                } else if (target.classList.contains('surplus-input')) {
                    insumo.surplus = value;
                }

                // Recalcular y actualizar la celda 'Gastado'
                const gastado = Math.max(0, insumo.separated - insumo.surplus);
                const row = target.closest('tr');
                row.querySelector('.gastado-cell').textContent = gastado;
                
                saveFloorDataToFirestore();
            }
        });

        tableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const name = button.dataset.name;

            if (button.classList.contains('delete-button')) {
                showConfirmModal(
                    'Confirmar Eliminación',
                    `¿Estás seguro de que quieres eliminar "${name}"? Esta acción no se puede deshacer.`,
                    () => {
                        floorsData[currentFloor] = floorsData[currentFloor].filter(i => i.name !== name);
                        saveFloorDataToFirestore();
                        renderTable();
                    }
                );
            } else if (button.classList.contains('edit-button')) {
                const insumo = floorsData[currentFloor].find(i => i.name === name);
                if (insumo) {
                    document.getElementById('edit-original-name').value = insumo.name;
                    document.getElementById('edit-insumo-name').value = insumo.name;
                    document.getElementById('edit-insumo-inventory').value = insumo.inventory;
                    editModal.classList.remove('hidden');
                }
            }
        });

        addInsumoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('new-insumo-name');
            const inventoryInput = document.getElementById('new-insumo-inventory');
            
            const newName = nameInput.value.trim().toUpperCase();
            const newInventory = Math.max(0, parseInt(inventoryInput.value, 10) || 0);

            if (!newName) {
                // Usar modal de confirmación como mensaje de error simple
                showConfirmModal('Error', 'El nombre del insumo no puede estar vacío.', () => hideConfirmModal());
                document.getElementById('confirm-ok-button').textContent = 'Entendido';
                return;
            }

            const exists = floorsData[currentFloor].some(i => i.name.toLowerCase() === newName.toLowerCase());
            if (exists) {
                showConfirmModal('Error', 'Este insumo ya existe en la lista.', () => hideConfirmModal());
                document.getElementById('confirm-ok-button').textContent = 'Entendido';
                return;
            }

            floorsData[currentFloor].push({
                name: newName,
                inventory: newInventory,
                separated: 0,
                surplus: 0
            });

            saveFloorDataToFirestore();
            renderTable();
            addInsumoForm.reset();
        });

        editInsumoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const originalName = document.getElementById('edit-original-name').value;
            const newName = document.getElementById('edit-insumo-name').value.trim().toUpperCase();
            const newInventory = Math.max(0, parseInt(document.getElementById('edit-insumo-inventory').value, 10) || 0);

            if (!newName) {
                showConfirmModal('Error', 'El nombre del insumo no puede estar vacío.', () => hideConfirmModal());
                document.getElementById('confirm-ok-button').textContent = 'Entendido';
                return;
            }

            // Verificar si el nuevo nombre ya existe (y no es el mismo insumo)
            const exists = floorsData[currentFloor].some(i => i.name.toLowerCase() === newName.toLowerCase() && i.name !== originalName);
            if (exists) {
                showConfirmModal('Error', 'Ya existe otro insumo con ese nombre.', () => hideConfirmModal());
                document.getElementById('confirm-ok-button').textContent = 'Entendido';
                return;
            }
            
            const insumo = floorsData[currentFloor].find(i => i.name === originalName);
            if (insumo) {
                insumo.name = newName;
                insumo.inventory = newInventory;
                saveFloorDataToFirestore();
                renderTable();
                editModal.classList.add('hidden');
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        endDayButton.addEventListener('click', () => {
            showConfirmModal(
                'Finalizar Día',
                'Esta acción actualizará el inventario con los valores gastados y reiniciará los campos para el día siguiente. ¿Estás seguro?',
                () => {
                    const insumos = floorsData[currentFloor];
                    insumos.forEach(insumo => {
                        const gastado = Math.max(0, insumo.separated - insumo.surplus);
                        insumo.inventory -= gastado;
                        if (insumo.inventory < 0) insumo.inventory = 0; // Evitar inventario negativo
                        
                        // Sobrante pasa a ser lo separado del día siguiente
                        insumo.separated = insumo.surplus; 
                        insumo.surplus = 0;
                    });
                    saveFloorDataToFirestore();
                    renderTable();
                }
            );
        });
        
        // Inicializar la aplicación al cargar el DOM
        document.addEventListener('DOMContentLoaded', () => {
            floorSelector.value = currentFloor; // Asegurar que el selector refleje el piso inicial
            floorTitle.textContent = `Control de Unidades - ${currentFloor.replace('_', ' ')}`;
            setupFirebaseAndAuth();
        });

        // Limpieza de listener al cerrar/salir
        window.addEventListener('beforeunload', () => {
            unsubscribeFloor();
        });

    </script>
</body>
</html>
