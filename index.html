<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Unidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* Estilo para inputs de la tabla */
        .table-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-align: center;
        }
        .table-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        /* ESTILO PARA COLUMNA GASTADO */
        .gastado-cell.highlight {
            font-size: 1.125rem; /* Text large */
            font-weight: 700; /* Bold */
            color: #dc2626; /* text-red-600 */
        }
        /* Estilo para items de la lista de historial */
        .history-list-item:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .history-list-item.active {
            background-color: #e5e7eb; /* bg-gray-200 */
            font-weight: 600;
        }
        /* Corregir el scroll para el modal de historial y evitar que la ventana principal se mueva */
        #history-modal .modal-content {
            max-height: 90vh; /* Limita la altura del modal */
            overflow-y: auto; /* Permite scroll en el modal si es necesario */
        }
        /* Contenedor de lista de fechas con scroll forzado */
        #history-list {
            max-height: 400px; /* Altura máxima para el scroll de las fechas */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-indicator" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50">
        <div class="p-4 bg-white rounded-lg shadow-lg flex items-center space-x-3">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">Cargando datos y conectando a Firebase...</span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-lg">

        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
            <h1 id="floor-title" class="text-3xl font-bold text-gray-800 text-center mb-4 md:mb-0"></h1>
            <div class="flex items-center space-x-4">
                <select id="floor-selector" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option>SUBSUELO</option>
                    <option>PLANTA BAJA</option>
                    <option>PISO 1</option>
                    <option>PISO 2</option>
                    <option>PISO 3</option>
                </select>
                <button id="view-history-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md whitespace-nowrap">
                    Ver Historial
                </button>
                <button id="end-day-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md whitespace-nowrap">
                    Finalizar Día
                </button>
            </div>
        </header>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="text-left py-3 px-4 uppercase font-semibold text-sm w-2/5">Insumo</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Inventario</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Separado</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Sobrante</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Gastado</th>
                        <th class="text-center py-3 px-4 uppercase font-semibold text-sm">Acciones</th>
                    </tr>
                </thead>
                <tbody id="insumos-table-body" class="text-gray-700">
                    </tbody>
            </table>
        </div>

        <div class="mt-8 pt-6 border-t">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Agregar Nuevo Insumo</h2>
            <form id="add-insumo-form" class="flex flex-col md:flex-row items-end gap-4">
                <div class="flex-grow w-full">
                    <label for="new-insumo-name" class="block text-sm font-medium text-gray-700">Nombre del Insumo</label>
                    <input type="text" id="new-insumo-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="w-full md:w-auto">
                    <label for="new-insumo-inventory" class="block text-sm font-medium text-gray-700">Inventario Inicial</label>
                    <input type="number" id="new-insumo-inventory" min="0" value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                    Agregar
                </button>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Insumo</h2>
            <form id="edit-insumo-form">
                <input type="hidden" id="edit-original-name">
                <div class="mb-4">
                    <label for="edit-insumo-name" class="block text-sm font-medium text-gray-700">Nombre del Insumo</label>
                    <input type="text" id="edit-insumo-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-6">
                    <label for="edit-insumo-inventory" class="block text-sm font-medium text-gray-700">Inventario</label>
                    <input type="number" id="edit-insumo-inventory" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <div id="history-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 modal-content">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Historial de Cierres - <span id="history-floor-title"></span></h2>
                <button id="close-history-button" class="text-gray-500 hover:text-gray-800 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex space-x-6 h-full">
                <div class="w-1/3 border-r pr-6 flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Registros por Fecha</h3>
                    <ul id="history-list" class="space-y-1 overflow-y-auto flex-grow"> 
                        <li class="text-gray-500 text-center py-4">Cargando...</li>
                    </ul>
                </div>

                <div class="w-2/3">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3" id="history-detail-title">Selecciona una fecha...</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-2 px-3 uppercase font-semibold text-xs">Insumo</th>
                                    <th class="text-center py-2 px-3 uppercase font-semibold text-xs">Inv. Inicial</th>
                                    <th class="text-center py-2 px-3 uppercase font-semibold text-xs">Separado</th>
                                    <th class="text-center py-2 px-3 uppercase font-semibold text-xs">Sobrante</th> <th class="text-center py-2 px-3 uppercase font-semibold text-xs">Gastado</th>
                                </tr>
                            </thead>
                            <tbody id="history-detail-body" class="text-gray-700">
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">El detalle del día aparecerá aquí.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 modal-content text-center">
            <h2 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-button" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md">Cancelar</button>
                <button id="confirm-ok-button" class="bg-red-600 text-white px-6 py-2 rounded-md">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="success-toast" class="hidden fixed bottom-6 right-6 z-50">
        <div class="bg-green-600 text-white p-4 rounded-lg shadow-xl flex items-center space-x-3 transition duration-300 ease-out transform translate-y-full opacity-0" id="toast-content">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="font-semibold text-lg">¡Día Finalizado Correctamente!</span>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales y Setup de Firebase (MANDATORIO) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // CONFIGURACIÓN DE FIREBASE SOLICITADA POR EL USUARIO (ACTUALIZADA)
        const firebaseConfig = {
            apiKey: "AIzaSyDGKvnkPqv8d6egejRgM3F14Z_IY_M9ukc",
            authDomain: "controlunidadesceo.firebaseapp.com",
            projectId: "controlunidadesceo",
            storageBucket: "controlunidadesceo.firebasestorage.app",
            messagingSenderId: "7574596863",
            appId: "1:7574596863:web:cc2d5f53fcfdbbce9f70ca"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let unsubscribeFloor = () => {}; // Función para limpiar el listener anterior
        
        // Estado de la aplicación
        let floorsData = {};
        let currentFloor = localStorage.getItem('currentFloor') || 'SUBSUELO'; 
        let isAuthReady = false;
        let isFloorDataLoaded = false; 

        // Elementos del DOM
        const loadingIndicator = document.getElementById('loading-indicator');
        const floorSelector = document.getElementById('floor-selector');
        const floorTitle = document.getElementById('floor-title');
        const tableBody = document.getElementById('insumos-table-body');
        const addInsumoForm = document.getElementById('add-insumo-form');
        const endDayButton = document.getElementById('end-day-button');
        const editModal = document.getElementById('edit-modal');
        const editInsumoForm = document.getElementById('edit-insumo-form');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkButton = document.getElementById('confirm-ok-button');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const successToast = document.getElementById('success-toast');
        const toastContent = document.getElementById('toast-content');

        // --- ELEMENTOS DE HISTORIAL ---
        const viewHistoryButton = document.getElementById('view-history-button');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryButton = document.getElementById('close-history-button');
        const historyFloorTitle = document.getElementById('history-floor-title');
        const historyList = document.getElementById('history-list');
        const historyDetailTitle = document.getElementById('history-detail-title');
        const historyDetailBody = document.getElementById('history-detail-body');
        let floorHistoryData = {}; // Cache para el historial del piso actual

        // --- Funciones de Utilidad de Firebase ---
        function getFloorDocRef(floorName) {
            return doc(db, `artifacts/${appId}/public/data/inventory_control/${floorName}`);
        }
        
        // Obtener la referencia a la colección de historial para un piso
        function getHistoryCollectionRef(floorName) {
             return collection(db, `artifacts/${appId}/public/data/inventory_control/${floorName}/history`);
        }

        async function saveFloorDataToFirestore() {
            if (!db || !isAuthReady || !isFloorDataLoaded) {
                console.error("Firestore no está listo o la data no ha cargado para guardar.");
                return;
            }

            if (!floorsData[currentFloor]) return;

            const dataToSave = {
                insumos: floorsData[currentFloor],
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(getFloorDocRef(currentFloor), dataToSave, { merge: true });
            } catch (error) {
                console.error("Error al guardar datos de insumos en Firestore:", error);
            }
        }
        
        // Guardar el registro de cierre de día
        async function saveDayCloseRecord(recordData) {
            if (!db || !isAuthReady) {
                 console.error("Firestore no está listo para guardar el registro de cierre.");
                 return;
            }
            try {
                const historyRef = getHistoryCollectionRef(currentFloor);
                // El ID del documento es el timestamp para ordenar y asegurar unicidad
                const docId = new Date().toISOString().replace(/\./g, '_'); 
                await setDoc(doc(historyRef, docId), recordData);
                console.log(`Registro de cierre guardado exitosamente para ${currentFloor}`);
            } catch (error) {
                console.error("Error al guardar el registro de cierre de día:", error);
            }
        }


        function startFirestoreListener() {
            unsubscribeFloor();
            isFloorDataLoaded = false;
            
            if (!db || !isAuthReady) return;

            const docRef = getFloorDocRef(currentFloor);
            
            unsubscribeFloor = onSnapshot(docRef, (docSnap) => {
                const dataExists = docSnap.exists();
                
                if (dataExists) {
                    const data = docSnap.data();
                    const newInsumos = data.insumos || [];
                    const currentInsumos = floorsData[currentFloor];
                    
                    if (JSON.stringify(newInsumos) !== JSON.stringify(currentInsumos) || !isFloorDataLoaded) {
                        floorsData[currentFloor] = newInsumos;
                        renderTable();
                        isFloorDataLoaded = true;
                    }
                } else {
                    console.log(`Documento para ${currentFloor} no encontrado. Inicializando con array vacío.`);
                    floorsData[currentFloor] = [];
                    renderTable();
                    isFloorDataLoaded = true;
                }
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error al escuchar en Firestore:", error);
                loadingIndicator.classList.add('hidden');
            });
        }

        function switchFloor(newFloor) {
            localStorage.setItem('currentFloor', newFloor);
            currentFloor = newFloor;
            floorTitle.textContent = `Control de Unidades - ${currentFloor.replace('_', ' ')}`;
            historyFloorTitle.textContent = currentFloor.replace('_', ' '); // Actualizar título del modal de historial
            
            if (isAuthReady) {
                loadingIndicator.classList.remove('hidden');
                startFirestoreListener();
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Conectando...</td></tr>`;
            }
        }
        
        async function setupFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (tokenError) {
                        console.warn("Token personalizado falló. Intentando iniciar sesión anónimamente.", tokenError);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;
                switchFloor(currentFloor); 

            } catch (error) {
                console.error("Error al configurar Firebase/Auth:", error);
                loadingIndicator.innerHTML = '<span class="text-red-600">Error de conexión con la base de datos. Por favor, revisa la consola para más detalles.</span>';
            }
        }

        // --- Funciones de Historial ---

        function formatFirestoreTimestamp(timestampString) {
            // Asume que el ID del documento es un ISOString
            const date = new Date(timestampString.replace(/_/g, '.'));
            
            if (isNaN(date)) return timestampString;
            
            const formatter = new Intl.DateTimeFormat('es-CL', {
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', 
                hour12: false // Formato 24 horas
            });
            return formatter.format(date);
        }

        async function loadFloorHistory() {
            historyList.innerHTML = '<li class="text-gray-500 text-center py-4">Cargando historial...</li>';
            historyDetailBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">El detalle del día aparecerá aquí.</td></tr>'; // Colspan ajustado
            historyDetailTitle.textContent = 'Selecciona una fecha...';
            floorHistoryData = {}; // Limpiar caché

            try {
                const historyRef = getHistoryCollectionRef(currentFloor);
                // Consulta para obtener todos los documentos, ordenados por fecha de forma descendente (más recientes primero)
                const q = query(historyRef, orderBy('date', 'desc'));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<li class="text-gray-500 text-center py-4">No hay registros de cierre anteriores.</li>';
                    return;
                }

                historyList.innerHTML = ''; // Limpiar mensaje de carga
                querySnapshot.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    // Usar el campo 'date' que se guardará como ISOString para un mejor orden. Si no está, usa el ID.
                    const displayDate = data.date ? formatFirestoreTimestamp(data.date) : formatFirestoreTimestamp(docSnap.id);
                    
                    // Almacenar en caché el registro completo usando el ID de Firestore
                    floorHistoryData[docSnap.id] = data; 
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'history-list-item cursor-pointer p-2 rounded-md transition duration-150';
                    listItem.dataset.recordId = docSnap.id;
                    listItem.textContent = displayDate;
                    
                    listItem.addEventListener('click', () => {
                        // Resaltar el item seleccionado
                        document.querySelectorAll('.history-list-item').forEach(item => item.classList.remove('active'));
                        listItem.classList.add('active');
                        // Mostrar el detalle
                        renderHistoryDetail(docSnap.id);
                    });

                    historyList.appendChild(listItem);
                });
                
                // Muestra el detalle del registro más reciente por defecto
                if (querySnapshot.docs.length > 0) {
                    const latestId = querySnapshot.docs[0].id;
                    const latestItem = document.querySelector(`[data-record-id="${latestId}"]`);
                    if(latestItem) {
                        latestItem.classList.add('active');
                        renderHistoryDetail(latestId);
                    }
                }

            } catch (error) {
                console.error("Error al cargar el historial:", error);
                historyList.innerHTML = '<li class="text-red-500 text-center py-4">Error al cargar el historial.</li>';
            }
        }

        function renderHistoryDetail(recordId) {
            const record = floorHistoryData[recordId];
            if (!record) {
                historyDetailBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Registro no encontrado.</td></tr>';
                historyDetailTitle.textContent = 'Registro no encontrado';
                return;
            }

            // Usar el campo 'date' para el título
            const titleDate = record.date ? formatFirestoreTimestamp(record.date) : 'Detalle del Día';
            historyDetailTitle.textContent = `Detalle: ${titleDate}`;
            
            historyDetailBody.innerHTML = '';
            
            record.insumos.sort((a, b) => a.name.localeCompare(b.name));

            record.insumos.forEach(insumo => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="text-left py-2 px-3">${insumo.name}</td>
                    <td class="text-center py-2 px-3">${insumo.initialInventory}</td>
                    <td class="text-center py-2 px-3">${insumo.separated}</td>
                    <td class="text-center py-2 px-3">${insumo.surplus || 0}</td> <td class="text-center py-2 px-3 font-semibold ${insumo.gastado > 0 ? 'text-red-600' : 'text-gray-700'}">${insumo.gastado}</td>
                `;
                historyDetailBody.appendChild(row);
            });
        }


        // --- Funciones de Renderizado (Existentes) ---
        function renderTable() {
            tableBody.innerHTML = '';
            const insumos = floorsData[currentFloor] || []; 
            
            insumos.sort((a, b) => a.name.localeCompare(b.name));

            if (insumos.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay insumos para este piso. Agrega uno nuevo para empezar.</td></tr>`;
                return;
            }

            insumos.forEach(insumo => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                const gastado = Math.max(0, insumo.separated - insumo.surplus);
                const highlightClass = gastado > 0 ? 'highlight' : ''; 

                row.innerHTML = `
                    <td class="text-left py-3 px-4 font-medium">${insumo.name}</td>
                    <td class="text-center py-3 px-4">${insumo.inventory}</td>
                    <td class="text-center py-3 px-4"><input type="number" min="0" value="${insumo.separated}" class="table-input separated-input" data-name="${insumo.name}"></td>
                    <td class="text-center py-3 px-4"><input type="number" min="0" value="${insumo.surplus}" class="table-input surplus-input" data-name="${insumo.name}"></td>
                    <td class="text-center py-3 px-4 gastado-cell ${highlightClass}">${gastado}</td>
                    <td class="text-center py-3 px-4">
                        <button class="edit-button p-1 text-blue-600 hover:text-blue-800" data-name="${insumo.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a2 2 0 012-2h2.586l-4.586 4.586V12zM3 13.172V17h3.828l7.586-7.586-3.828-3.828L3 13.172z" /></svg>
                        </button>
                        <button class="delete-button p-1 text-red-600 hover:text-red-800" data-name="${insumo.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- Manejadores de Eventos ---
        
        // Manejador del botón Finalizar Día (Lógica de Validación Invertida y Corregida)
        endDayButton.addEventListener('click', () => {
            const insumos = floorsData[currentFloor];
            
            if (!insumos || insumos.length === 0) {
                 showConfirmModal('Error', 'No hay insumos para finalizar el día.', () => hideConfirmModal(), false);
                 return;
            }

            let separatedWithoutSurplus = false;
            let surplusExceedsSeparated = false;

            for (const insumo of insumos) {
                // Validación: Si separó, el sobrante no puede ser 0
                // **Esta es la validación clave que pides**: si Separado > 0 Y Sobrante = 0, no permitir
                if (insumo.separated > 0 && insumo.surplus === 0) {
                    separatedWithoutSurplus = true;
                }
                
                // Validación: Sobrante > Separado
                if (insumo.surplus > insumo.separated) {
                    surplusExceedsSeparated = true;
                    break; 
                }
            }

            // Validación 1: Sobrante > Separado (Error Fatal)
            if (surplusExceedsSeparated) {
                showConfirmModal(
                    'Error de Validación',
                    'No se puede finalizar el día: el valor de "Sobrante" no puede ser mayor que el valor de "Separado" en ningún insumo. Por favor, corrige los datos.',
                    () => { /* No action on confirm */ },
                    false 
                );
                return;
            }

            // Validación 2: Separado > 0 y Sobrante = 0
            if (separatedWithoutSurplus) {
                 showConfirmModal(
                    'Error de Validación',
                    'No se puede finalizar el día: si separaste insumos (Separado > 0), debes registrar el sobrante (Sobrante > 0).',
                    () => { /* No action on confirm */ },
                    false // Bloquea el cierre
                );
                return;
            }
            
            // Si todo está bien, pide confirmación para ejecutar la lógica de cierre
            showConfirmModal(
                'Finalizar Día',
                'Esta acción actualizará el inventario con los valores gastados y reiniciará los campos para el día siguiente. ¿Estás seguro?',
                () => executeDayEndLogic()
            );
            
        });

        // Función de Lógica de Cierre (Actualizada para incluir Sobrante en el historial)
        async function executeDayEndLogic() {
            const insumos = floorsData[currentFloor];
            const recordsToSave = [];
            const currentDate = new Date().toISOString();

            insumos.forEach(insumo => {
                const gastado = Math.max(0, insumo.separated - insumo.surplus);
                
                // Guardar la data para el registro de historial (AÑADIDO SURPLUS)
                recordsToSave.push({
                    name: insumo.name,
                    initialInventory: insumo.inventory, 
                    separated: insumo.separated,
                    surplus: insumo.surplus, // <--- AÑADIDO PARA EL HISTORIAL
                    gastado: gastado
                });

                // Actualizar el inventario y reiniciar campos
                insumo.inventory -= gastado;
                if (insumo.inventory < 0) insumo.inventory = 0; 
                insumo.separated = insumo.surplus; 
                insumo.surplus = 0;
            });
            
            // 1. Guardar el registro de historial PRIMERO
            await saveDayCloseRecord({
                date: currentDate,
                floor: currentFloor,
                insumos: recordsToSave 
            });

            // 2. Guardar el estado actual de los insumos (inventario actualizado)
            saveFloorDataToFirestore();
            renderTable();
            showSuccessToast(); 
        }

        // --- Manejadores de Historial ---
        viewHistoryButton.addEventListener('click', () => {
            historyModal.classList.remove('hidden');
            loadFloorHistory(); // Cargar datos del historial al abrir
        });
        
        closeHistoryButton.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });
        
        // --- Funciones de Modal / Confirmación (Existentes) ---
        function resetConfirmButtonStyles(isConfirmation) {
            // Asegura que el botón de OK sea rojo para las confirmaciones críticas y azul/verde para mensajes informativos
            if (isConfirmation) {
                confirmOkButton.textContent = 'Aceptar';
                confirmOkButton.classList.remove('bg-indigo-600', 'bg-green-600');
                confirmOkButton.classList.add('bg-red-600');
                confirmCancelButton.classList.remove('hidden');
            } else {
                confirmOkButton.textContent = 'Entendido';
                confirmOkButton.classList.remove('bg-red-600', 'bg-green-600');
                confirmOkButton.classList.add('bg-indigo-600');
                confirmCancelButton.classList.add('hidden');
            }
        }
        
        function showConfirmModal(title, message, onConfirm, isConfirmation = true) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');

            // Limpia listeners anteriores
            const oldOk = confirmOkButton.cloneNode(true);
            confirmOkButton.parentNode.replaceChild(oldOk, confirmOkButton);
            const newOk = document.getElementById('confirm-ok-button');
            
            const oldCancel = confirmCancelButton.cloneNode(true);
            confirmCancelButton.parentNode.replaceChild(oldCancel, confirmCancelButton);
            const newCancel = document.getElementById('confirm-cancel-button');
            
            resetConfirmButtonStyles(isConfirmation);

            const okHandler = () => {
                onConfirm();
                hideConfirmModal();
            };
            const cancelHandler = () => {
                hideConfirmModal();
            };
            
            newOk.addEventListener('click', okHandler);
            if (isConfirmation) {
                newCancel.addEventListener('click', cancelHandler);
            } else {
                // Si no es confirmación, el botón de cancelar no hace nada o está oculto.
                newCancel.addEventListener('click', cancelHandler); // Añadimos el handler, aunque esté oculto.
            }
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        function showSuccessToast() {
            try {
                const audioUrl = 'https://raw.githubusercontent.com/israelvayas/CONTROLUNIDADESCEO1.0/main/small-victory.mp3';
                const successAudio = new Audio(audioUrl);
                successAudio.volume = 1.0; 
                successAudio.load(); 
                successAudio.play().catch(e => console.warn("No se pudo reproducir el audio de éxito.", e));
            } catch (e) {
                 console.warn("Error al crear el objeto Audio:", e);
            }

            successToast.classList.remove('hidden');
            void toastContent.offsetWidth; 
            toastContent.classList.remove('translate-y-full', 'opacity-0');
            toastContent.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                toastContent.classList.remove('translate-y-0', 'opacity-100');
                toastContent.classList.add('translate-y-full', 'opacity-0');

                setTimeout(() => {
                    successToast.classList.add('hidden');
                }, 300);
            }, 10000);
        }

        // --- Event Listeners restantes (Existentes) ---
        floorSelector.addEventListener('change', (e) => {
            switchFloor(e.target.value);
        });

        tableBody.addEventListener('input', (e) => {
            const target = e.target;
            if (!target.classList.contains('table-input')) return;

            const name = target.dataset.name;
            const value = Math.max(0, parseInt(target.value, 10) || 0);
            target.value = value;
            
            const insumo = floorsData[currentFloor].find(i => i.name === name);

            if (insumo) {
                if (target.classList.contains('separated-input')) {
                    insumo.separated = value;
                } else if (target.classList.contains('surplus-input')) {
                    insumo.surplus = value;
                }

                const gastado = Math.max(0, insumo.separated - insumo.surplus);
                const row = target.closest('tr');
                const gastadoCell = row.querySelector('.gastado-cell');
                
                gastadoCell.textContent = gastado;
                if (gastado > 0) {
                    gastadoCell.classList.add('highlight');
                } else {
                    gastadoCell.classList.remove('highlight');
                }
                
                saveFloorDataToFirestore();
            }
        });

        tableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const name = button.dataset.name;

            if (button.classList.contains('delete-button')) {
                showConfirmModal(
                    'Confirmar Eliminación',
                    `¿Estás seguro de que quieres eliminar "${name}"? Esta acción no se puede deshacer.`,
                    () => {
                        floorsData[currentFloor] = floorsData[currentFloor].filter(i => i.name !== name);
                        saveFloorDataToFirestore();
                        renderTable();
                    }
                );
            } else if (button.classList.contains('edit-button')) {
                const insumo = floorsData[currentFloor].find(i => i.name === name);
                if (insumo) {
                    document.getElementById('edit-original-name').value = insumo.name;
                    document.getElementById('edit-insumo-name').value = insumo.name;
                    document.getElementById('edit-insumo-inventory').value = insumo.inventory;
                    editModal.classList.remove('hidden');
                }
            }
        });

        addInsumoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isFloorDataLoaded) {
                 showConfirmModal('Cargando', 'Por favor, espera un momento a que los datos del piso terminen de cargar.', () => hideConfirmModal(), false);
                 return;
            }
            
            const nameInput = document.getElementById('new-insumo-name');
            const inventoryInput = document.getElementById('new-insumo-inventory');
            
            const newName = nameInput.value.trim().toUpperCase();
            const newInventory = Math.max(0, parseInt(inventoryInput.value, 10) || 0);

            if (!newName) {
                showConfirmModal('Error', 'El nombre del insumo no puede estar vacío.', () => hideConfirmModal(), false);
                return;
            }

            const exists = floorsData[currentFloor].some(i => i.name.toLowerCase() === newName.toLowerCase());
            if (exists) {
                showConfirmModal('Error', 'Este insumo ya existe en la lista.', () => hideConfirmModal(), false);
                return;
            }

            floorsData[currentFloor].push({
                name: newName,
                inventory: newInventory,
                separated: 0,
                surplus: 0
            });

            saveFloorDataToFirestore();
            renderTable();
            addInsumoForm.reset();
        });

        editInsumoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const originalName = document.getElementById('edit-original-name').value;
            const newName = document.getElementById('edit-insumo-name').value.trim().toUpperCase();
            const newInventory = Math.max(0, parseInt(document.getElementById('edit-insumo-inventory').value, 10) || 0);

            if (!newName) {
                showConfirmModal('Error', 'El nombre del insumo no puede estar vacío.', () => hideConfirmModal(), false);
                return;
            }

            const exists = floorsData[currentFloor].some(i => i.name.toLowerCase() === newName.toLowerCase() && i.name !== originalName);
            if (exists) {
                showConfirmModal('Error', 'Ya existe otro insumo con ese nombre.', () => hideConfirmModal(), false);
                return;
            }
            
            const insumo = floorsData[currentFloor].find(i => i.name === originalName);
            if (insumo) {
                insumo.name = newName;
                insumo.inventory = newInventory;
                saveFloorDataToFirestore();
                renderTable();
                editModal.classList.add('hidden');
            }
        });

        cancelEditButton.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });
        
        // Inicializar la aplicación al cargar el DOM
        document.addEventListener('DOMContentLoaded', () => {
            floorSelector.value = currentFloor;
            
            if (floorSelector.value !== currentFloor) {
                currentFloor = 'SUBSUELO';
                floorSelector.value = currentFloor;
            }

            floorTitle.textContent = `Control de Unidades - ${currentFloor.replace('_', ' ')}`;
            historyFloorTitle.textContent = currentFloor.replace('_', ' '); // Inicializar título del modal
            setupFirebaseAndAuth();
        });

        window.addEventListener('beforeunload', () => {
            unsubscribeFloor();
        });

    </script>
</body>
</html>